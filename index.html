<!DOCTYPE html>
<meta charset=utf-8>
<title id=ttle>Arbeitszeitrechner</title>
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
<!--[if lt IE 10]><script type="text/javascript">window.onload = function() {window.open("iesucks.htm", "_self");}</script><![endif]-->

<div id=wrapper1>
    <section id=part1>
        <div id=frame><a href=index.html id=logoclick>
                <header id=title>
                    <h1>Arbeitszeitrechner</h1>
                </header>
            </a>
            <section id=form>
                <div class=table>
                    <div class=tableRow>
                        <p>Ankunftszeit<p><input id=arrival name=arrival placeholder=hhmm/hmm> <p><span id=namehelp
                                    class=helptext></span>
                    </div>
                    <div class=tableRow>
                        <p>Geplante Überstunden<p><input id=overtime name=overtime placeholder=(-)hhmm/(-)hmm/(-)mm>
                                    <p><span id=overtimehelp class=helptext></span>
                    </div>
                    <div class=tableRow>
                        <p>Feierabend<p><span id=endtime></span>
                                <p><span id=toolatewarning class=helptext></span>
                    </div>
                    <div class=tableRow>
                        <p>Arbeitszeit<p><span id=worktime></span>
                    </div>
                    <div class=tableRow>
                        <p>Pause<p><span id=pauseinput></span> <input id=pausetime name=points max=59 min=0 step=1
                                    type=range value=30>
                                <p><span id=pausewarning class=helptext></span>
                    </div>
                </div>
				<div class=tableRow id=backgroundControl>
					<div class=child>
						<label for="inputFileToLoad" class="custom-file-upload">
							Hintergrundbild wählen
						</label>
						<input id="inputFileToLoad" type="file" onchange="encodeImageFileAsURL()"/>
					</div>
					<div>
						<select id=backgroundMode class="custom-file-upload child" onchange="backgroundModeChanged()">
							<option value="auto">Auto</option>
							<option value="length">Length</option>
							<option value="cover">Cover</option>
							<option value="contain">Contain</option>
						</select>
						<select id=backgroundRepeat class="custom-file-upload child" onchange="backgroundModeChanged()">
							<option value="no-repeat">No repeat</option>
							<option value="repeat">Repeat</option>
							<option value="repeat-x">Repeat-X</option>
							<option value="repeat-y">Repeat-Y</option>
						</select>
					</div>
					<button onclick="resetBackground()" class="custom-file-upload child" style="color: #e50000">Hintergrund zurücksetzen</button>
				</div>
                <p id=countdown>00:00:00<p id=overtimecounter>
            </section>
        </div><span id=progressbar></span>
        <div id=progressnumber><span id=percentnumber class=blur></span></div>
    </section>
</div>

<script>
    const DEFAULT_WORK_TIME = 27360;   // 7,6h
    const MAX_WORK_TIME = 36000;       // 10h
    const MIN_PAUSE_6H = 1800;         // 30min
    const MIN_PAUSE_10H = 2700;        // 45min
    const LATEST_WORK_HOUR = 20;
    const EARLIEST_WORK_HOUR = 6;

    // LocalStorage Keys
    const LS_ARRIVAL = "time_arrival";
    const LS_OVERTIME = "time_overtime";
    const LS_BACKGROUND_IMG = "background_base64";
    const LS_BACKGROUND_MODE = "background_mode";
    const LS_BACKGROUND_REPEAT = "background_repeat";

    // ------------------ Zeitklasse ------------------
    class Time {
        constructor(seconds = 0) {
            this.totalSeconds = seconds;
            this.recalculate();
        }

        recalculate() {
            this.seconds = Math.abs(this.totalSeconds) % 60;
            this.minutes = Math.floor(Math.abs(this.totalSeconds) % 3600 / 60);
            this.hours = Math.floor(Math.abs(this.totalSeconds) / 3600);
            if (this.totalSeconds < 0) {
                this.hours *= -1;
                this.minutes *= -1;
                this.seconds *= -1;
            }
        }

        addSeconds(sec) { this.totalSeconds += sec; this.recalculate(); }
        addMinutes(min) { this.addSeconds(min * 60); }
        addHours(h) { this.addSeconds(h * 3600); }
        subtractSeconds(sec) { this.addSeconds(-sec); }
        subtractMinutes(min) { this.addMinutes(-min); }
        subtractHours(h) { this.addHours(-h); }

        reset() { this.totalSeconds = 0; this.recalculate(); }

        toShortString() {
            const neg = this.totalSeconds < 0 ? "-" : "";
            const h = String(Math.abs(this.hours)).padStart(2, "0");
            const m = String(Math.abs(this.minutes)).padStart(2, "0");
            return `${neg}${h}:${m}`;
        }

        toString() {
            const s = String(Math.abs(this.seconds)).padStart(2, "0");
            return `${this.toShortString()}:${s}`;
        }

        getTotalSeconds() { return this.totalSeconds; }
    }

    // ------------------ Globale Variablen ------------------
    let WORK_TIME, pauseTime, effectiveWorkTime, MAX_OVERTIME;
    let arrival = new Time(0);
    let overtime = new Time(0);
    let timerId, overtimerId;

    // ------------------ Init ------------------
    window.addEventListener("load", onLoad);

    function onLoad() {
        reset();

        WORK_TIME = new Time(DEFAULT_WORK_TIME);
        pauseTime = new Time(MIN_PAUSE_6H);
        effectiveWorkTime = new Time(pauseTime.getTotalSeconds() + WORK_TIME.getTotalSeconds());
        MAX_OVERTIME = new Time(MAX_WORK_TIME - DEFAULT_WORK_TIME);

        // Input Events
        document.getElementById("arrival").addEventListener("keyup", startTimer);
        document.getElementById("overtime").addEventListener("keyup", startTimer);
        //document.getElementById("pausetime").addEventListener("input", sliderChanged);

        // Background laden
        pullBackground();

        // Werte aus LocalStorage laden
        document.getElementById("arrival").value = localStorage.getItem(LS_ARRIVAL) || "";
        document.getElementById("overtime").value = localStorage.getItem(LS_OVERTIME) || "";
        document.getElementById("backgroundMode").value = localStorage.getItem(LS_BACKGROUND_MODE) || "auto";
        document.getElementById("backgroundRepeat").value = localStorage.getItem(LS_BACKGROUND_REPEAT) || "no-repeat";
    }

    // ------------------ Hintergrund ------------------
    function pullBackground() {
        const img = localStorage.getItem(LS_BACKGROUND_IMG);
        if (img) document.body.style.backgroundImage = `url('${img}')`;

        const mode = localStorage.getItem(LS_BACKGROUND_MODE);
        if (mode) document.body.style.backgroundSize = mode;

        const repeat = localStorage.getItem(LS_BACKGROUND_REPEAT);
        if (repeat) document.body.style.backgroundRepeat = repeat;
    }

    function backgroundModeChanged() {
        localStorage.setItem(LS_BACKGROUND_MODE, document.getElementById("backgroundMode").value);
        localStorage.setItem(LS_BACKGROUND_REPEAT, document.getElementById("backgroundRepeat").value);
        pullBackground();
    }

    function resetBackground() {
        localStorage.removeItem(LS_BACKGROUND_IMG);
        localStorage.removeItem(LS_BACKGROUND_MODE);
        localStorage.removeItem(LS_BACKGROUND_REPEAT);
        location.reload();
    }

    function encodeImageFileAsURL() {
        const file = document.getElementById("inputFileToLoad").files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            localStorage.setItem(LS_BACKGROUND_IMG, e.target.result);
            pullBackground();
        };
        reader.readAsDataURL(file);
    }

    // ------------------ Timer Logik ------------------
    function startTimer() {
        reset();
        const validArrival = validateArrivalTime(document.getElementById("namehelp"));
        const validOvertime = validateOvertime(document.getElementById("overtimehelp"));

        if (validArrival && validOvertime) {
            document.getElementById("pauseinput").textContent = pauseTime.toShortString();
            pauseChanged();
        }
    }

    function pauseChanged() {
        clearInterval(timerId);
        clearInterval(overtimerId);

        const warningElem = document.getElementById("pausewarning");
        if (!validatePauseTime(warningElem)) return;

        effectiveWorkTime = new Time(pauseTime.getTotalSeconds() + WORK_TIME.getTotalSeconds());

        const endTime = new Time(arrival.getTotalSeconds() + overtime.getTotalSeconds() + effectiveWorkTime.getTotalSeconds());

        document.getElementById("endtime").textContent =
            endTime.getTotalSeconds() > 86400 ? ">24:00" : `${endTime.toShortString()} Uhr`;

        document.getElementById("worktime").textContent =
            new Time(WORK_TIME.getTotalSeconds() + overtime.getTotalSeconds()).toShortString();

        if (endTime.getTotalSeconds() > LATEST_WORK_HOUR * 3600) {
            updateHelpText(document.getElementById("toolatewarning"), HELP_TEXT_TOO_LATE, true);
            return;
        }

        timer_tick(endTime);
        timerId = setInterval(() => timer_tick(endTime), 1000);
    }

    // ------------------ Reset ------------------
    function reset() {
        document.getElementById("countdown").textContent = "00:00:00";
        document.getElementById("endtime").textContent = "";
        document.getElementById("progressbar").style.visibility = "hidden";
        document.getElementById("percentnumber").textContent = "";
        document.getElementById("ttle").textContent = "Arbeitszeitrechner";
        document.getElementById("toolatewarning").textContent = "";
        document.getElementById("worktime").textContent = "";
        document.getElementById("overtimecounter").textContent = "";
        document.getElementById("pauseinput").textContent = "";
        document.getElementById("pausetime").disabled = true;
        document.getElementById("pausewarning").textContent = "";

        [...document.getElementsByClassName("helptext")].forEach(el => el.classList.add("helptextgreen"));

        clearInterval(timerId);
        clearInterval(overtimerId);

        document.getElementById("part1").classList.remove("endarkenpart1");
        document.getElementById("frame").classList.remove("enlightenframe");
        document.getElementById("countdown").classList.remove("pulse");
    }

    // ------------------ Hilfsfunktionen ------------------
    function updateHelpText(elem, text, isError) {
        if (!elem) return;
        if (isError) {
            elem.textContent = text;
            elem.classList.remove("helptextgreen");
        } else {
            elem.textContent = "✓";
            elem.classList.add("helptextgreen");
        }
    }

    // ------------------ Texte ------------------
    const HELP_TEXT_ARRIVAL = "Bitte im Format hhmm oder hmm eingeben.";
    const HELP_TEXT_OVERTIME = "Bitte im Format (-)hhmm, (-)hmm oder (-)mm eingeben.";
    const HELP_TEXT_PAUSE = "Bitte im Format hhmm, hmm oder mm eingeben.";
    const HELP_TEXT_TOO_MUCH_OVERTIME = `Mehr als ${new Time(MAX_WORK_TIME - DEFAULT_WORK_TIME)}h Überstunden sind nicht zulässig.`;
    const HELP_TEXT_TOO_FEW_OVERTIME = `Mehr als ${new Time(DEFAULT_WORK_TIME)}h abzubauende Stunden sind nicht zulässig.`;
    const HELP_TEXT_TOO_EARLY = "Vor 6:00 Uhr darf nicht begonnen werden.";
    const HELP_TEXT_TOO_LATE = "Es darf nicht länger als bis 20:00 Uhr gearbeitet werden.";
</script>

<style>
    body {
        font-family: Calibri, Helvetica, sans-serif;
		background-color: rgba(50, 50, 50, 1);
    }

    body,
    html {
        height: 100%;
        margin: 0;
    }

    #wrapper1 {
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center top;
        background-size: 100% 100%;
        margin: 0;
        padding: 0;
        position: absolute;
        width: 100%;
        height: 100%;
    }

    #part1 {
        background-color: rgba(0, 0, 0, 0);
        padding-top: 30px;
        margin: 0
    }

    #part2 {
        font-family: "Open Sans";
        font-size: 150px;
        color: #eee;
        line-height: 1em;
        margin-top: -50px;
        padding: 0;
        height: 100%
    }
	
	#backgroundControl {
		display: grid;
		grid-template-columns: 1fr 1fr 1fr;
		width: 620px;
		height: 32px;
	}
	
	#backgroundControl .child {
		width: 180px;
		text-align: center;
	}
	
	#backgroundControl select.child {
		width: 100px;
		text-align: center;
	}
	
	input[type="file"] {
        display: none;
    }

    .custom-file-upload {
        border: 1px solid #000000;
		background-color: rgba(200, 200, 200, 0.5);
        display: inline-block;
        padding: 6px 12px;
        cursor: pointer;
    }

    @keyframes endarken {
        from {
            background-color: rgba(0, 0, 0, 0)
        }

        to {
            background-color: rgba(0, 0, 0, .6)
        }
    }

    @keyframes enlighten {
        from {
            background-color: rgba(255, 255, 255, .5)
        }

        to {
            background-color: rgba(255, 255, 255, .9)
        }
    }

    @keyframes pulse {
        from {
            color: rgba(255, 0, 0, 1)
        }

        33% {
            color: rgba(255, 0, 0, 1)
        }

        to {
            color: rgba(255, 0, 0, 0)
        }
    }

    .endarkenpart1 {
        animation: endarken 4s forwards
    }

    .enlightenframe {
        animation: enlighten 4s forwards
    }

    .pulse {
        animation: pulse 2s infinite alternate
    }

    #part2 {
        background-color: #333;
        height: 1000px
    }

    input {
        background-color: rgba(255, 255, 255, .5);
        border: 0;
        padding: 6px;
        width: 290px;
        border-radius: 5px
    }

    input#pausetime,
    input#pausetime:focus,
    input#pausetime:hover {
        background-color: rgba(0, 0, 0, 0);
        padding: 0;
        box-shadow: none;
        border: none;
        width: 200px
    }

    #pauseinput {
        display: inline-block;
        width: 70px
    }

    input:focus,
    input:hover {
        padding: 5px;
        border: 1px solid rgba(255, 255, 255, .8);
        box-shadow: 0 0 5px rgba(255, 255, 255, .8) inset
    }

    #frame {
        width: 700px;
        margin-left: auto;
        margin-right: auto;
        border-radius: 5px;
        background-color: rgba(255, 255, 255, .5)
    }

    header#title {
        color: #3b3b3b;
        padding: 30px 10px 30px 10px;
        text-align: center;
        font-family: "Open Sans"
    }

    section {
        padding: 0 20px 20px 20px
    }

    #endtime {
        text-align: right !important
    }

    #progressbar {
        position: absolute;
        top: 100%;
        right: 0;
        left: 0;
        box-shadow: 0 0 15px 10px rgba(255, 255, 255, 1);
        visibility: hidden
    }

    #percentnumber {
        position: absolute;
        top: 93%;
        left: 50%;
        right: 50%;
        color: rgba(255, 255, 255, .5);
        display: block;
        font-size: 36px;
        font-family: "Open Sans";
        font-weight: 300
    }

    .blur {
        text-shadow: 0 0 32px #900;
        color: transparent
    }

    .infobox {
        background-color: rgba(255, 255, 255, .5);
        border-radius: 2px;
        cursor: pointer;
        border: 1px solid #ccc;
        float: left;
        border-radius: 5px
    }

    #box1 {
        margin-right: -10% !important;
        margin-left: 85% !important;
        margin-top: -7% !important;
        padding-left: 7px !important;
        padding-right: 7px !important;
        padding-top: 2px !important;
        border-radius: 5px
    }

    #box2 {
        margin-right: -25% !important;
        margin-left: 90% !important;
        margin-top: -7% !important;
        padding-left: 5px !important;
        padding-right: 5px !important;
        padding-top: 2px !important;
        border-radius: 5px
    }

    #boxZWS {
        margin-right: -40% !important;
        margin-left: 80% !important;
        margin-top: -7% !important;
        padding-left: 5px !important;
        padding-right: 5px !important;
        padding-top: 2px !important
    }

    .info {
        font-family: "Courier New", monospace;
        font-size: 120%;
        color: #d00
    }

    .smalladvice {
        font-style: italic;
        line-height: 1.2em;
        font-size: 90%
    }

    .table {
        margin-top: 20px;
        display: table
    }

    .table:hover {
        max-height: 100px
    }

    .fadeOut {
        max-height: 0
    }

    .tableRow {
        display: table-row;
        height: 32px
    }

    .tableRow p {
        display: table-cell;
        vertical-align: top;
        padding: 3px
    }

    .tableRow p:first-child {
        text-align: right
    }

    .tableRow p:nth-child(2) {
        padding-left: 15px;
        width: 300px
    }

    h1 {
        font-size: 240%;
        padding: 0;
        margin: 0
    }

    h2 {
        padding: 0;
        margin: 0
    }

    a#logoclick {
        color: #3b3b3b;
        text-decoration: none
    }

    header#title {
        transition: background-color .2s ease-in
    }

    header#title:hover {
        background-color: rgba(230, 230, 230, .5)
    }

    footer#mainfooter {
        font-size: 70%;
        text-align: center
    }

    #countdown {
        font-size: 400%;
        font-family: "Open Sans", sans-serif;
        font-weight: 300;
        color: #e55;
        margin-left: auto;
        margin-right: auto;
        text-align: center;
        cursor: default
    }

    #overtimecounter {
        font-size: 150%;
        font-family: "Open Sans", sans-serif;
        font-weight: 300;
        color: #e55;
        margin-left: auto;
        margin-right: auto;
        text-align: center;
        cursor: default
    }

    .helptext {
        margin-left: 20px;
        padding: 5px;
        font-size: 80%;
        color: red;
        float: left;
        position: absolute;
        border: 1px solid rgba(255, 255, 255, .8);
        box-shadow: 0 0 5px rgba(255, 255, 255, .8) inset;
        background-color: rgba(255, 255, 255, .3);
        border-radius: 5px
    }

    .helptextgreen {
        color: green !important;
        border: none !important;
        background-color: rgba(0, 0, 0, 0) !important;
        box-shadow: none !important
    }

    @keyframes scrollbg {
        from {
            background-position: center top
        }

        to {
            background-position: 50% 100%
        }
    }

    .stretchani {
        background-size: 100% 100000%
    }

    .scrollani {
        animation: scrollbg 10s infinite alternate linear
    }

    @keyframes drive {
        0% {
            margin-left: 33%;
            margin-top: 30px
        }

        12% {
            margin-left: 32.5%
        }

        25% {
            margin-left: 33.5%
        }

        37% {
            margin-left: 32%
        }

        50% {
            margin-left: 33%
        }

        62% {
            margin-left: 32%
        }

        75% {
            margin-left: 32.5%
        }

        87% {
            margin-left: 32%
        }

        100% {
            margin-left: 33%;
            margin-top: 20%
        }
    }

    @keyframes driveongoing {
        0% {
            margin-left: 33%;
            margin-top: 20%
        }

        12% {
            margin-left: 32.5%
        }

        25% {
            margin-left: 33.5%
        }

        37% {
            margin-left: 32%
        }

        50% {
            margin-left: 33%;
            margin-top: 20.3%
        }

        62% {
            margin-left: 32%
        }

        75% {
            margin-left: 32.5%
        }

        87% {
            margin-left: 32%
        }

        100% {
            margin-left: 33%;
            margin-top: 20%
        }
    }

    .driveani {
        animation: drive 1s forwards
    }

    .driveongoingani {
        animation: driveongoing .8s infinite
    }
</style>