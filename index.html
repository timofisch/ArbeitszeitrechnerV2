<!DOCTYPE html>
<meta charset=utf-8>
<title id=ttle>Arbeitszeitrechner</title>
<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>

<body>
	<div id=wrapper1>
		<section id=part1>
			<div id=frame><a href=index.html id=logoclick>
					<header id=title>
						<h1>Arbeitszeitrechner</h1>
					</header>
				</a>
				<section id=form>
					<div class=table>
						<div class=tableRow>
							<p>Ankunftszeit<p><input autocomplete="off" id=arrival name=arrival placeholder=hhmm/hmm/hh/h> <p><span id=arrivalhelp
										class=helptext></span>
						</div>
						<div class=tableRow>
							<p>Geplante Überstunden<p><input autocomplete="off" id=overtime name=overtime placeholder=(-)hhmm/(-)hmm/(-)mm>
										<p><span id=overtimehelp class=helptext></span>
						</div>
						<div class=tableRow>
							<p>Feierabend<p><input autocomplete="off" id=endtime name=endtime placeholder=hhmm/hmm/hh/h> <p><span id=toolatewarninghelp
										class=helptext></span>
						</div>
						<div class=tableRow>
							<p>Arbeitszeit<p><input autocomplete="off" id=worktime name=worktime placeholder=hhmm/hmm/hh/h> <p><span id=worktimehelp
										class=helptext></span>
						</div>
                        <div class=tableRow>
							<p>Pause<p><input autocomplete="off" id=pausetime name=pausetime placeholder=hhmm/hmm/mm> <p><span id=pausewarning
										class=helptext></span>
						</div>
					</div>
					<div class=tableRow id=backgroundControl>
						<div class=child>
							<label for="inputFileToLoad" class="custom-file-upload">
								Hintergrundbild wählen
							</label>
							<input id="inputFileToLoad" type="file" accept="image/*"/>
						</div>
						<div>
							<select id=backgroundMode class="custom-file-upload child">
								<option value="auto">Auto</option>
								<option value="cover">Cover</option>
								<option value="contain">Contain</option>
                                <option value="custom">Custom</option>
							</select>
							<select id=backgroundRepeat class="custom-file-upload child">
								<option value="no-repeat">No repeat</option>
								<option value="repeat">Repeat</option>
								<option value="repeat-x">Repeat-X</option>
								<option value="repeat-y">Repeat-Y</option>
							</select>
						</div>
						<div class="child">
                            <button class="custom-file-upload" id="resetBackground">Hintergrund zurücksetzen</button>
                        </div>
                        <div class="child" style="grid-column: 2; grid-row: 2;">
                            <label><input id="cbxMoveBackground" type="checkbox" disabled>Hintergrund bewegen</label>
                        </div>
                        <div class="child" style="grid-column: 3; grid-row: 2;">
                            <button class="custom-file-upload" id="resetBackSettings">Einstellungen löschen</button>
                        </div>
					</div>
					<p id=countdown>00:00:00<p id=overtimecounter></p></p>
                    <p><a href="mailto:timon.fischer@f-i.de?subject=Arbeitszeitrechner Bug-Meldung - Betreff nicht bearbeiten&body=[Bug Beschreibung]" id="reportBug">Bug melden</a></p>
				</section>
			</div><span id=progressbar></span>
			<div id=progressnumber><span id="progressNumber" class=blur></span></div>
		</section>
	</div>
</body>

<script>
    // -------------- Default values ---------------
    const DEFAULT_WORK_TIME = getTotalMinutes("07:36")   	// 7,6h
    const MAX_WORK_TIME = getTotalMinutes("10:00")       	// 10h
    const MIN_PAUSE_6H = getTotalMinutes("00:30")        	// 30min
    const MIN_PAUSE_9H = getTotalMinutes("00:45")        	// 45min
    const LATEST_WORK_HOUR = getTotalMinutes("20:00")
    const EARLIEST_WORK_HOUR = getTotalMinutes("06:00")

    // -------------- Local Storage Keys ---------------
    const LS_ARRIVAL = "time_arrival"
    const LS_OVERTIME = "time_overtime"
    const LS_LAST_TIME_UPDATE = "time_lastUpdate"
    const LS_PAUSE = "time_pause"
    const LS_PAUSE_CHANGED = "time_pauseChanged"
    const LS_BACKGROUND_SIZE = "background_size"
    const LS_BACKGROUND_REPEAT = "background_repeat"
    const LS_BACKGROUND_POSITION = "background_position"
    const LS_BACKGROUND_ZOOM = "background_zoom"
    
    // ------------------ HTML Elements ------------------
    const inputArrival = document.getElementById("arrival")
    const inputOvertime = document.getElementById("overtime")
    const inputPause = document.getElementById("pausetime")
    const inputEndtime = document.getElementById("endtime")
    const inputWorktime = document.getElementById("worktime")

    const inputBackgroundFile = document.getElementById("inputFileToLoad")
    const inputBackgroundMode = document.getElementById("backgroundMode")
    const inputBackgroundRepeat = document.getElementById("backgroundRepeat")
    const inputBackgroundReset = document.getElementById("resetBackground")
    const inputBackgroundResetSettings = document.getElementById("resetBackSettings")
    const inputBackgroundMove = document.getElementById("cbxMoveBackground")

    const progressbar = document.getElementById("progressbar")
    const progressNumber = document.getElementById("progressNumber")

    const countdownElement = document.getElementById("countdown")
    const overtimeCounter = document.getElementById("overtimecounter")

    // ------------------ Event Listener ------------------
    window.addEventListener("load", onLoad)

    inputArrival.addEventListener("change", onChangeArrival)
    inputOvertime.addEventListener("change", onChangeOvertime)
    inputEndtime.addEventListener("change", onChangeEndtime)
    inputWorktime.addEventListener("change", onChangeWorktime)
    inputPause.addEventListener("change", onChangePause)

    inputBackgroundFile.addEventListener("change", saveBackground)
    inputBackgroundMode.addEventListener("change", backgroundModeChanged)
    inputBackgroundRepeat.addEventListener("change", backgroundModeChanged)
    inputBackgroundReset.addEventListener("click", resetBackground)
    inputBackgroundResetSettings.addEventListener("click", resetBackgroundSettings)
    inputBackgroundMove.addEventListener("change", (e) => {
        if(e.target.checked) {
            document.body.addEventListener("mousedown", backMouseDown)
            document.body.addEventListener("wheel", backScale)

            inputArrival.disabled = true
            inputOvertime.disabled = true
            inputEndtime.disabled = true
            inputWorktime.disabled = true
            inputPause.disabled = true
            inputBackgroundFile.disabled = true
            inputBackgroundMode.disabled = true
            inputBackgroundRepeat.disabled = true
            inputBackgroundReset.disabled = true
        }
        else {
            document.body.removeEventListener("mousedown", backMouseDown)
            document.body.removeEventListener("mouseup", backMouseUp)
            document.body.removeEventListener("wheel", backScale)

            inputArrival.disabled = false
            inputOvertime.disabled = false
            inputEndtime.disabled = false
            inputWorktime.disabled = false
            inputPause.disabled = false
            inputBackgroundFile.disabled = false
            inputBackgroundMode.disabled = false
            inputBackgroundRepeat.disabled = false
            inputBackgroundReset.disabled = false
        }
    })

    // ------------------ Variables ------------------
    let timer
    let mouseStartPos

    // ------------------ OnLoad ------------------
    function onLoad() {
        const lastUpdate = localStorage.getItem(LS_LAST_TIME_UPDATE)
        
        loadBackground()
        
        if(lastUpdate == getISODate(new Date())) {
            const arrival = getDisplayedTime(localStorage.getItem(LS_ARRIVAL))
            const overtime = getDisplayedTime(localStorage.getItem(LS_OVERTIME))
            const pausetime = getDisplayedTime(localStorage.getItem(LS_PAUSE))
            
            const backMode = localStorage.getItem(LS_BACKGROUND_SIZE)
            const backRepeat = localStorage.getItem(LS_BACKGROUND_REPEAT)
            
            if(arrival)
                inputArrival.value = `${arrival.hrs}:${arrival.min}`
            
            if(overtime)
                inputOvertime.value = `${overtime.prefix}${overtime.hrs}:${overtime.min}`
            
            if(pausetime && arrival)
                inputPause.value = `${pausetime.hrs}:${pausetime.min}`


            if(arrival) {
                updateEndtime()
                updateWorktime("overtime")
                countdown()
            }

            if(backMode)
                inputBackgroundMode.value = backMode

            if(backRepeat)
                inputBackgroundRepeat.value = backRepeat
        }
        else
            resetInputs(true)
    }

    // ------------------ Input Events ------------------
    function onChangeArrival() {
        if(inputArrival.value != "" && inputArrival.value * 1 != 0) {
            let convertedTime

            if(inputArrival.value.length >= 3)
                convertedTime = convertInput(inputArrival.value, "min")
            else
                convertedTime = convertInput(inputArrival.value, "hrs")

            localStorage.setItem(LS_ARRIVAL, getTotalMinutes(convertedTime))
            inputArrival.value = convertedTime
            
            updateLastChange()
            
            if(localStorage.getItem(LS_OVERTIME) * 1 != 0)
                updateWorktime("overtime")
            else
                updateWorktime("default")

            updatePausetime()
            updateEndtime()
        }
        else {
            resetInputs(false)
        }
    }

    function onChangeOvertime() {
        if(inputArrival.value && inputOvertime.value * 1 != 0) {
            const convertedTime = convertInput(inputOvertime.value, "min")
            localStorage.setItem(LS_OVERTIME, getTotalMinutes(convertedTime))
            inputOvertime.value = convertedTime
        }
        else {
            inputOvertime.value = ``
            localStorage.setItem(LS_OVERTIME, 0)
        }
        
        if(inputArrival.value != "") {
            updateWorktime("overtime")
            updatePausetime()
            updateEndtime()
        }
    }

    function onChangePause() {
        const minTotalMinutes = getMinPausetime()

        if(inputArrival.value) {
            const minPausetime = getDisplayedTime(minTotalMinutes)
            
            if(inputPause.value * 1 <= 0) {
                localStorage.setItem(LS_PAUSE, minTotalMinutes)

                if(minTotalMinutes > 0)
                    inputPause.value = `${minPausetime.hrs}:${minPausetime.min}`
                else
                    inputPause.value = ``
            }
            else {
                const convertedTime = convertInput(inputPause.value, "min")
                const totalMinutes = getTotalMinutes(convertedTime)

                if(totalMinutes >= minTotalMinutes) {
                    localStorage.setItem(LS_PAUSE, totalMinutes)
                    inputPause.value = convertedTime
                }
                else {
                    localStorage.setItem(LS_PAUSE, minTotalMinutes)
                    inputPause.value = `${minPausetime.hrs}:${minPausetime.min}`
                }
            }
        }
        else {
            inputPause.value = ``
            localStorage.setItem(LS_PAUSE, 0)
        }

        if(localStorage.getItem(LS_PAUSE) > minTotalMinutes)
            localStorage.setItem(LS_PAUSE_CHANGED, true)
        else
            localStorage.setItem(LS_PAUSE_CHANGED, false)
            
        updateWorktime("endtime")
        updateOvertime()
    }

    function onChangeEndtime() {
        const val = inputEndtime.value

        if(inputArrival.value && val * 1 != 0) {
            let convertedTime
            
            if(val.length >= 3)
                convertedTime = convertInput(val, "min")
            else
                convertedTime = convertInput(val, "hrs")

            inputEndtime.value = convertedTime
        }
        else {
            inputEndtime.value = ``
        }

        if(inputArrival.value != "") {
            updateWorktime("endtime")
            updateOvertime()
            updatePausetime()
            updateWorktime("endtime")
            countdown()
        }
    }

    function onChangeWorktime() {
        const val = inputWorktime.value

        if(inputArrival.value && val * 1 != 0) {
            let convertedTime

            if(val.length >= 3)
                convertedTime = convertInput(val, "min")
            else
                convertedTime = convertInput(val, "hrs")

            inputWorktime.value = convertedTime
        }
        else {
            inputWorktime.value = ``
        }

        if(inputArrival.value != "") {
            updatePausetime()
            updateOvertime()
            updateEndtime()
        }
    }

    // ------------------ Input Update Calculations ------------------
    function updateEndtime() {
        const arrivalTime = localStorage.getItem(LS_ARRIVAL) * 1
        const overtimeTime = localStorage.getItem(LS_OVERTIME) * 1
        const pauseTime = localStorage.getItem(LS_PAUSE) * 1
        
        const endtime = arrivalTime + DEFAULT_WORK_TIME + overtimeTime + pauseTime

        const time = getDisplayedTime(endtime)
        inputEndtime.value = `${time.hrs}:${time.min}`

        countdown()
    }

    function updateWorktime(e) {        //e: "default" for default; "overtime" for calculation with overtime; "endtime" for calculation with endtime
        let worktime

        if(e == "endtime")
            worktime = getTotalMinutes(inputEndtime.value) - localStorage.getItem(LS_ARRIVAL) - localStorage.getItem(LS_PAUSE)
        else if(e == "overtime")
            worktime = DEFAULT_WORK_TIME + localStorage.getItem(LS_OVERTIME) * 1
        else
            worktime = DEFAULT_WORK_TIME

        const time = getDisplayedTime(worktime)
        inputWorktime.value = `${time.hrs}:${time.min}`
    }

    function updateOvertime() {
        const worktime = getTotalMinutes(inputWorktime.value)

        const overtime = worktime - DEFAULT_WORK_TIME
        localStorage.setItem(LS_OVERTIME, overtime)

        if(overtime != 0) {
            const time = getDisplayedTime(overtime)
            inputOvertime.value = `${time.prefix}${time.hrs}:${time.min}`
        }
        else
            inputOvertime.value = ``
    }

    function updatePausetime() {
        let pausetime = 0

        if(localStorage.getItem(LS_PAUSE_CHANGED) == "false") {
            pausetime = getMinPausetime()
            localStorage.setItem(LS_PAUSE, pausetime)
        }
        else
            pausetime = localStorage.getItem(LS_PAUSE)

        if(pausetime > 0) {
            const displayedPause = getDisplayedTime(pausetime)
            inputPause.value = `${displayedPause.hrs}:${displayedPause.min}`
        }
        else
            inputPause.value = ``
    }

    // ------------------ Services ------------------
    function getISODate(d) {
        return new Date(d).toISOString().split("T")[0]
    }

    function getISOTime(d) {
        return new Date(d).toLocaleTimeString()
    }

    function updateLastChange() {
        localStorage.setItem(LS_LAST_TIME_UPDATE, getISODate(new Date()))
    }

    function resetInputs(e) {       //e: true = reset pause too | false = don't reset pause
        inputArrival.value = ``
        inputOvertime.value = ``
        inputEndtime.value = ``
        inputWorktime.value = ``
        inputPause.value = ``

        localStorage.setItem(LS_ARRIVAL, 0)
        localStorage.setItem(LS_OVERTIME, 0)
        
        if(e || localStorage.getItem(LS_PAUSE_CHANGED) == "false") {
            localStorage.setItem(LS_PAUSE, 0)
            localStorage.setItem(LS_PAUSE_CHANGED, false)
        }

        clearInterval(timer)
        overtimeCounter.innerHTML = ``
        countdownElement.innerHTML = `00:00:00`
        document.title = `Arbeitszeitrechner`
        progressNumber.innerHTML = ``
        progressbar.style.visibility = `hidden`
    }

    function convertInput(str, e) {     //e: "min" = 1 or 2 digits is minutes | "hrs" = 1 or 2 digits is hours
        if(str) {
            if(e == "min") {
                let min = 0

                if(!str.includes(":")) {
                    let neg = false

                    if(str.startsWith("-")) {
                        str = str.slice(1)
                        neg = true
                    }

                    const s = str.split("")

                    if(s.length == 4)
                        min = ((s[0] + s[1]) * 60) + (s[2] + s[3]) * 1
                    else if(s.length == 3)
                        min = (s[0] * 60) + (s[1] + s[2]) * 1
                    else if(s.length == 2)
                        min = (s[0] + s[1]) * 1
                    else if(s.length == 1)
                        min = s[0] * 1

                    if(neg)
                        min *= -1
                }
                else {
                    min = getTotalMinutes(str)
                }

                const time = getDisplayedTime(min)
                
                return `${time.prefix}${time.hrs}:${time.min}`
            }
            else if(e == "hrs") {
                const value = str * 1

                return `${String(value).padStart(2, 0)}:00`
            }
        }
        else
            return ""
    }

    function getMinPausetime(min) {     //min: Worktime in minutes
        let worktime
        let pausetime = 0

        if(!min)
            worktime = getTotalMinutes(inputWorktime.value)
        else
            worktime = min

        if(worktime > 9 * 60)
            pausetime = MIN_PAUSE_9H
        else if(worktime > 6 * 60)
            pausetime = MIN_PAUSE_6H

        return pausetime
    }

    function arrFromIntStr(str) {
        let result = str
        
        result = result.replaceAll(`[`, ``)
        result = result.replaceAll(`]`, ``)
        result = result.split(`,`)

        result[0] *= 1
        result[1] *= 1

        return result
    }

    function getPercent(val1, val2) {
        const rawNum = (val1 / val2) * 100

        if(rawNum >= 100)
            return 100
        else if(rawNum <= 0)
            return 0

        return rawNum.toFixed(2) * 1
    }

    // ------------------ Background Settings ------------------
    function backgroundModeChanged() {
        const selectedMode = inputBackgroundMode.value

        localStorage.setItem(LS_BACKGROUND_SIZE, inputBackgroundMode.value)

        if(selectedMode == "custom") {
            const lsZoom = localStorage.getItem(LS_BACKGROUND_ZOOM)

            if(!lsZoom)
                localStorage.setItem(LS_BACKGROUND_ZOOM, 100)
        }

        localStorage.setItem(LS_BACKGROUND_REPEAT, inputBackgroundRepeat.value)
        
        updateBackgroundSettings()
    }

    function resetBackground() {
        if(confirm(`Möchtest du wirklich das Hintergrundbild und die Hintergrundeinstellungen zurücksetzen?`)) {
            localStorage.removeItem(LS_BACKGROUND_SIZE)
            localStorage.removeItem(LS_BACKGROUND_REPEAT)
            localStorage.removeItem(LS_BACKGROUND_POSITION)
            localStorage.removeItem(LS_BACKGROUND_ZOOM)
            deleteBackground()
            location.reload()
        }
    }

    function resetBackgroundSettings() {
        if(confirm(`Möchtest du wirklich die Hintergrundeinstellungen zurücksetzen?`)) {
            localStorage.removeItem(LS_BACKGROUND_SIZE)
            localStorage.removeItem(LS_BACKGROUND_REPEAT)
            localStorage.removeItem(LS_BACKGROUND_POSITION)
            localStorage.removeItem(LS_BACKGROUND_ZOOM)
            location.reload()
        }
    }

    function updateBackgroundSettings() {
        const mode = localStorage.getItem(LS_BACKGROUND_SIZE)
        const repeat = localStorage.getItem(LS_BACKGROUND_REPEAT)
        let position = localStorage.getItem(LS_BACKGROUND_POSITION)
        
        if(mode) {
            if(mode == "custom")
                updateBackgroundSize(`${localStorage.getItem(LS_BACKGROUND_ZOOM)}%`)
            else
                updateBackgroundSize(mode)
        }

        if(repeat) {
            document.body.style.backgroundRepeat = repeat
        }

        if(position) {
            updateBackgroundPos(arrFromIntStr(position))
        }
    }

    function updateBackgroundSize(size) {
        if(!isNaN(size))
            document.body.style.backgroundSize = `${size}% auto`
        else
            document.body.style.backgroundSize = size
    }

    function updateBackgroundPos(pos) {
        document.body.style.backgroundPosition = `${pos[0]}px ${pos[1]}px`
    }

    function backMouseDown(e) {
        mouseStartPos = [e.x, e.y]

        document.body.addEventListener("mousemove", backMouseMove)
        document.body.addEventListener("mouseup", backMouseUp)
    }

    function backMouseMove(e) {
        const mousePos = [e.x, e.y]
        let currentBackPos

        const lsBackPos = localStorage.getItem(LS_BACKGROUND_POSITION)

        if(lsBackPos)
            currentBackPos = arrFromIntStr(lsBackPos)
        else
            currentBackPos = [0, 0]        

        const posAfterMove = [mousePos[0] - mouseStartPos[0] + currentBackPos[0], mousePos[1] - mouseStartPos[1] + currentBackPos[1]]

        updateBackgroundPos(posAfterMove)
    }

    function backMouseUp(e) {
        document.body.removeEventListener("mousemove", backMouseMove)

        let str = document.body.style.backgroundPosition

        str = str.replaceAll(`px`, ``)
        str = str.split(` `)

        localStorage.setItem(LS_BACKGROUND_POSITION, str)
    }

    function backScale(e) {
        const changeZoom = e.deltaY / 100 * -1.7
        let currentZoom = localStorage.getItem(LS_BACKGROUND_ZOOM) * 1

        if(currentZoom <= 0)
            currentZoom = 100 

        const newZoom = Math.round((currentZoom + changeZoom)*100) / 100

        if(localStorage.getItem(LS_BACKGROUND_SIZE) != "custom") {
            localStorage.setItem(LS_BACKGROUND_SIZE, "custom")
            updateBackgroundSettings()
            inputBackgroundMode.value = "custom"
        }

        localStorage.setItem(LS_BACKGROUND_ZOOM, newZoom)
        updateBackgroundSize(newZoom)
    }

    // ------------------ Time ------------------
    function getTotalMinutes(t) {
        if(t) {
            let str
            let neg = false
            let min = 0
            
            str = t.split(`:`)

            if(str[0].startsWith("-")) {
                str[0] = str[0].slice(1)
                neg = true
            }

            for(let i = 0; i < str.length; i++)
                str[i] *= 1

            if(str.length == 1)
                min = str[0]
            else if(str.length == 2)
                min = (str[0] * 60) + str[1]

            
            if(neg)
                min *= -1

            return min
        }
        else
            return 0
    }

    function getDisplayedTime(min) {
        min *= 1

        if(min && min != 0) {
            let prefix = ``
            
            if(min < 0) {
                prefix = `-`
                min *= -1
            }
            
            const hours = Math.floor(min / 60)
            const minutes = min - (hours * 60)

            return {
                hrs: `${String(hours).padStart(2, `0`)}`,
                min: `${String(minutes).padStart(2, `0`)}`,
                prefix: `${prefix}`
            }
        }
    }

    function getTotalSeconds(t) {
        let str = t.split(":")
        let sec = 0

        for(let i = 0; i < str.length; i++)
            str[i] *= 1

        if(str[0] > 0)
            sec += str[0] * 3600

        if(str[1] > 0)
            sec += str[1] * 60

        if(str[2] > 0)
            sec += str[2]

        return sec
    }

    function getDisplayedTimeS(sec) {
        sec *= 1

        if(sec >= 0) {
            let seconds
            let minutes = Math.floor(sec / 60)
            const hours = Math.floor(minutes / 60)

            if(minutes > 0)
                seconds = sec % (minutes * 60)
            else
                seconds = sec

            if(hours > 0)
                minutes = minutes % (hours * 60)

            return {
                hrs: `${String(hours).padStart(2, `0`)}`,
                min: `${String(minutes).padStart(2, `0`)}`,
                sec: `${String(seconds).padStart(2, `0`)}`
            }
        }
    }

    // ------------------ Timer ------------------
    function countdown() {
        clearInterval(timer)
        
        const secsEndtime = getTotalMinutes(inputEndtime.value) * 60

        timer = setInterval(() => {
            const secsNow = getTotalSeconds(getISOTime(new Date()))
            let percent

            const diff = secsEndtime - secsNow

            if(diff > 0) {
                const timeDiff = getDisplayedTimeS(diff)
                const showedString = `${timeDiff.hrs}:${timeDiff.min}:${timeDiff.sec}`
                percent = getPercent(secsNow - localStorage.getItem(LS_ARRIVAL) * 60, getTotalMinutes(inputEndtime.value) * 60 - localStorage.getItem(LS_ARRIVAL) * 60)
                
                countdownElement.innerHTML = showedString
                overtimeCounter.innerHTML = ``
                document.title = `${showedString} | Arbeitszeitrechner`
            }
            else {
                document.title = `Feierabend! | Arbeitszeitrechner`
                countdownElement.innerHTML = `Feierabend!`
                percent = 100

                let overtime = calcOvertimeCounter(secsNow, -diff)

                if(overtime < 0)
                    overtime = 0

                const timeDiff = getDisplayedTimeS(overtime)
                
                if(!isNaN(overtime))
                    overtimeCounter.innerHTML = `Überstunden: ${timeDiff.hrs}:${timeDiff.min}:${timeDiff.sec}`
            }

            progressbar.style.visibility = `visible`
            progressbar.style.right = `${100 - percent}%`
            progressNumber.innerHTML = `${percent.toFixed(0)}%`
        }, 1000)
    }

    function calcOvertimeCounter(secNow, diff) {
        const overtime = diff / 60
        const pause = localStorage.getItem(LS_PAUSE) * 1
        const currPresenceTime = (secNow / 60) - localStorage.getItem(LS_ARRIVAL) * 1
        const currWorktime = currPresenceTime - pause

        const pauseNotPlanned = getMinPausetime(currWorktime) - pause

        //Total pause is already calculated so no more action is needed
        if(pause >= 45 || currWorktime < 6 * 60)
            return Math.round(overtime * 60)
        else {
            if(currWorktime > 9 * 60 && currWorktime < 9 * 60 + MIN_PAUSE_9H - MIN_PAUSE_6H)
                return Math.round((overtime - ((pauseNotPlanned - MIN_PAUSE_9H + MIN_PAUSE_6H) + currWorktime - 9 * 60)) * 60)
            else if(currWorktime > 6 * 60 && currWorktime < 6 * 60 + MIN_PAUSE_6H)
                return Math.round((overtime - (pauseNotPlanned + currWorktime - 6 * 60)) * 60)
            else
                return Math.round((overtime - pauseNotPlanned) * 60)
        }
    }

    // ------------------ IndexedDB - Background Image ------------------
    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open("backgroundDB", 1)

            request.onupgradeneeded = (e) => {
                const db = e.target.result
                
                if (!db.objectStoreNames.contains("images")) {
                    db.createObjectStore("images")
                }
            }

            request.onsuccess = () => resolve(request.result)
            request.onerror = () => reject(request.error)
        })
    }

    async function saveBackground() {
        const file = inputBackgroundFile.files[0]

        if(file) {
            const db = await initDB()
        
            return new Promise((resolve, reject) => {
                const tx = db.transaction("images", "readwrite")
                const store = tx.objectStore("images")
                
                store.put(file, "background")

                tx.oncomplete = () => resolve()
                tx.onerror = () => reject(tx.error)

                loadBackground()
            })
        }
    }

    async function loadBackground() {
        const db = await initDB()
        
        return new Promise((resolve, reject) => {
            const tx = db.transaction("images", "readonly")
            const store = tx.objectStore("images")
            const request = store.get("background")

            request.onsuccess = () => {
                const file = request.result
                if (file) {
                    inputBackgroundMove.disabled = false
                    const url = URL.createObjectURL(file)
                    document.body.style.backgroundImage = `url(${url})`
                }
                else
                    inputBackgroundMove.disabled = true
                resolve(file)
            }
            request.onerror = () => reject(request.error)

            updateBackgroundSettings()
        })
    }

    async function deleteBackground() {
        const db = await initDB()
        return new Promise((resolve, reject) => {
            const tx = db.transaction("images", "readwrite")
            const store = tx.objectStore("images")
            const request = store.delete("background")

            tx.oncomplete = () => {
                document.body.style.backgroundImage = ""; // Hintergrund zurücksetzen
                resolve()
            }

            tx.onerror = () => reject(tx.error)

            loadBackground()
        })
    }

    // ------------------ Texts ------------------
    const HELP_TEXT_ARRIVAL = "Bitte im Format hhmm oder hmm eingeben.";
    const HELP_TEXT_OVERTIME = "Bitte im Format (-)hhmm, (-)hmm oder (-)mm eingeben.";
    const HELP_TEXT_PAUSE = "Bitte im Format hhmm, hmm oder mm eingeben.";
    const HELP_TEXT_TOO_MUCH_OVERTIME = "Mehr als 2:24h Überstunden sind nicht zulässig."//`Mehr als ${new Time(MAX_WORK_TIME - DEFAULT_WORK_TIME)}h Überstunden sind nicht zulässig.`;
    const HELP_TEXT_TOO_FEW_OVERTIME = "Mehr als 7:36h abzubauende Stunden sind nicht zulässig."//`Mehr als ${new Time(DEFAULT_WORK_TIME)}h abzubauende Stunden sind nicht zulässig.`;
    const HELP_TEXT_TOO_EARLY = "Vor 6:00 Uhr darf nicht begonnen werden.";
    const HELP_TEXT_TOO_LATE = "Es darf nicht länger als bis 20:00 Uhr gearbeitet werden.";
</script>

<style>
    :root {
        --red: #ee3e3e;
        --inputBack: rgba(255, 255, 255, 0.5);
    }

    body {
        font-family: Calibri, Helvetica, sans-serif;
		background-color: rgba(50, 50, 50, 1);
		background-repeat: no-repeat;
    }

    body,
    html {
        height: 100%;
        margin: 0;
    }

    #wrapper1 {
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center top;
        background-size: 100% 100%;
        margin: 0;
        padding: 0;
        position: absolute;
        width: 100%;
        height: 100%;
    }

    #part1 {
        background-color: rgba(0, 0, 0, 0);
        padding-top: 30px;
        margin: 0;
    }

    #part2 {
        font-family: "Open Sans";
        font-size: 150px;
        color: #eee;
        line-height: 1em;
        margin-top: -50px;
        padding: 0;
        height: 100%
    }

    #reportBug {
        font-size: 16px;
        text-align: center;
        margin-left: calc(50% - 38.7px);
    }
	
	#backgroundControl {
		display: grid;
		grid-template-columns: 0.95fr 1fr 0.95fr;
        grid-template-rows: 1fr 1fr;
		width: 620px;
		height: 33px;
        margin-top: 2px;
	}
	
	#backgroundControl .child {
		width: 180px;
        height: 33px;
		text-align: center;
        margin-left: auto;
        margin-right: auto;
	}
	
	#backgroundControl select.child {
        height: 33px;
		text-align: center;
	}

    #backgroundControl select.child:first-child {
        width: 98px;
	}

    #backgroundControl select.child:last-child {
        width: 110px;
	}

    #resetBackground, #resetBackSettings {
        color: #e50000;
        height: 33px;
        width: 178px;
    }

    #cbxMoveBackground {
        width: 15px;
        height: 15px;
        margin: 7px 5px 0px 0px;
    }
	
	input[type="file"] {
        display: none;
    }

    .custom-file-upload {
        border: 1px solid #000000;
		background-color: rgba(200, 200, 200, 0.5);
        display: inline-block;
        padding: 6px 12px;
        cursor: pointer;
    }

    @keyframes endarken {
        from {
            background-color: rgba(0, 0, 0, 0)
        }

        to {
            background-color: rgba(0, 0, 0, .6)
        }
    }

    @keyframes enlighten {
        from {
            background-color: rgba(255, 255, 255, .5)
        }

        to {
            background-color: rgba(255, 255, 255, .9)
        }
    }

    @keyframes pulse {
        from {
            color: rgba(255, 0, 0, 1)
        }

        33% {
            color: rgba(255, 0, 0, 1)
        }

        to {
            color: rgba(255, 0, 0, 0)
        }
    }

    .endarkenpart1 {
        animation: endarken 4s forwards
    }

    .enlightenframe {
        animation: enlighten 4s forwards
    }

    .pulse {
        animation: pulse 2s infinite alternate
    }

    #part2 {
        background-color: #333;
        height: 1000px
    }

    input {
        background-color: var(--inputBack);
        border: 0;
        padding: 6px;
        width: 290px;
        border-radius: 5px
    }

    input:focus,
    input:hover {
        padding: 5px;
        border: 1px solid rgba(255, 255, 255, .8);
        box-shadow: 0 0 5px rgba(255, 255, 255, .8) inset
    }

    #frame {
        width: 700px;
        margin-left: auto;
        margin-right: auto;
        border-radius: 50px;
        background-color: rgba(255, 255, 255, .5)
    }

    header#title {
        color: #3b3b3b;
        padding: 30px 10px 30px 10px;
        text-align: center;
        font-family: "Open Sans"
    }

    section {
        padding: 0 20px 20px 20px
    }

    #progressbar {
        position: absolute;
        top: 100%;
        right: 0;
        left: 0;
        box-shadow: 0 0 15px 10px rgba(255, 255, 255, 1);
        visibility: hidden
    }

    #progressNumber {
        position: absolute;
        top: 93%;
        left: 50%;
        right: 50%;
        color: rgba(255, 255, 255, .5);
        display: block;
        font-size: 36px;
        font-family: "Open Sans";
        font-weight: 300
    }

    .blur {
        text-shadow: 0 0 32px #900;
        color: transparent
    }

    .infobox {
        background-color: rgba(255, 255, 255, .5);
        border-radius: 2px;
        cursor: pointer;
        border: 1px solid #ccc;
        float: left;
        border-radius: 5px
    }

    #box1 {
        margin-right: -10% !important;
        margin-left: 85% !important;
        margin-top: -7% !important;
        padding-left: 7px !important;
        padding-right: 7px !important;
        padding-top: 2px !important;
        border-radius: 5px
    }

    #box2 {
        margin-right: -25% !important;
        margin-left: 90% !important;
        margin-top: -7% !important;
        padding-left: 5px !important;
        padding-right: 5px !important;
        padding-top: 2px !important;
        border-radius: 5px
    }

    #boxZWS {
        margin-right: -40% !important;
        margin-left: 80% !important;
        margin-top: -7% !important;
        padding-left: 5px !important;
        padding-right: 5px !important;
        padding-top: 2px !important
    }

    .info {
        font-family: "Courier New", monospace;
        font-size: 120%;
        color: #d00
    }

    .smalladvice {
        font-style: italic;
        line-height: 1.2em;
        font-size: 90%
    }

    .table {
        margin-top: 20px;
        display: table
    }

    .table:hover {
        max-height: 100px
    }

    .fadeOut {
        max-height: 0
    }

    .tableRow {
        display: table-row;
        height: 32px
    }

    .tableRow p {
        display: table-cell;
        vertical-align: top;
        padding: 3px
    }

    .tableRow p:first-child {
        text-align: right
    }

    .tableRow p:nth-child(2) {
        padding-left: 15px;
        width: 300px
    }

    h1 {
        font-size: 240%;
        padding: 0;
        margin: 0
    }

    h2 {
        padding: 0;
        margin: 0
    }

    a#logoclick {
        color: #3b3b3b;
        text-decoration: none
    }

    header#title {
        transition: background-color .2s ease-in
    }

    header#title:hover {
        background-color: rgba(230, 230, 230, .5)
    }

    footer#mainfooter {
        font-size: 70%;
        text-align: center
    }

    #countdown {
        font-size: 400%;
        font-family: "Open Sans", sans-serif;
        font-weight: 300;
        color: var(--red);
        margin-left: auto;
        margin-right: auto;
        text-align: center;
        cursor: default
    }

    #overtimecounter {
        font-size: 150%;
        font-family: "Open Sans", sans-serif;
        font-weight: 300;
        color: var(--red);
        margin-left: auto;
        margin-right: auto;
        text-align: center;
        cursor: default
    }

    .helptext {
        margin-left: 20px;
        padding: 5px;
        font-size: 80%;
        color: red;
        float: left;
        position: absolute;
        border: 1px solid rgba(255, 255, 255, .8);
        box-shadow: 0 0 5px rgba(255, 255, 255, .8) inset;
        background-color: rgba(255, 255, 255, .3);
        border-radius: 5px
    }

    .helptextgreen {
        color: green !important;
        border: none !important;
        background-color: rgba(0, 0, 0, 0) !important;
        box-shadow: none !important
    }

    @keyframes scrollbg {
        from {
            background-position: center top
        }

        to {
            background-position: 50% 100%
        }
    }

    .stretchani {
        background-size: 100% 100000%
    }

    .scrollani {
        animation: scrollbg 10s infinite alternate linear
    }

    @keyframes drive {
        0% {
            margin-left: 33%;
            margin-top: 30px
        }

        12% {
            margin-left: 32.5%
        }

        25% {
            margin-left: 33.5%
        }

        37% {
            margin-left: 32%
        }

        50% {
            margin-left: 33%
        }

        62% {
            margin-left: 32%
        }

        75% {
            margin-left: 32.5%
        }

        87% {
            margin-left: 32%
        }

        100% {
            margin-left: 33%;
            margin-top: 20%
        }
    }

    @keyframes driveongoing {
        0% {
            margin-left: 33%;
            margin-top: 20%
        }

        12% {
            margin-left: 32.5%
        }

        25% {
            margin-left: 33.5%
        }

        37% {
            margin-left: 32%
        }

        50% {
            margin-left: 33%;
            margin-top: 20.3%
        }

        62% {
            margin-left: 32%
        }

        75% {
            margin-left: 32.5%
        }

        87% {
            margin-left: 32%
        }

        100% {
            margin-left: 33%;
            margin-top: 20%
        }
    }

    .driveani {
        animation: drive 1s forwards
    }

    .driveongoingani {
        animation: driveongoing .8s infinite
    }

    * {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
</style>